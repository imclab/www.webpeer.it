(function(E){function s(o){var h=s.modules[o];if(!h)throw"couldn't find module for: "+o;if(!h.exports){h.exports={};h.call(h.exports,h.exports,F(o))}return h.exports}function F(o){var h=o.replace(/[^\/]*$/,"");return function(f){f=(h+f).replace(/\/\.\//,"/").replace(/[^/]*\/\.\./,"").replace(/\/\//,"/");return s(f)}}if(!window.console){var B=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"];window.console={};for(var z=
0;z<B.length;++z)window.console[B[z]]=function(){}}s.modules={};s.module=function(o,h){s.modules[o]=h};s.module("./base64",function(o){var h={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",encode_safe:function(f){var j="",a,c,b,m,n,k,d=0;for(f=h._utf8_encode(f);d<f.length;){a=f.charCodeAt(d++);c=f.charCodeAt(d++);b=f.charCodeAt(d++);m=a>>2;a=(a&3)<<4|c>>4;n=(c&15)<<2|b>>6;k=b&63;if(isNaN(c))n=k=64;else if(isNaN(b))k=64;j=j+h._keyStr.charAt(m)+h._keyStr.charAt(a)+h._keyStr.charAt(n)+
h._keyStr.charAt(k)}return j},decode_safe:function(f){var j="",a,c,b,m,n,k=0;for(f=f.replace(/[^A-Za-z0-9\-\_\=]/g,"");k<f.length;){a=h._keyStr.indexOf(f.charAt(k++));c=h._keyStr.indexOf(f.charAt(k++));m=h._keyStr.indexOf(f.charAt(k++));n=h._keyStr.indexOf(f.charAt(k++));a=a<<2|c>>4;c=(c&15)<<4|m>>2;b=(m&3)<<6|n;j+=String.fromCharCode(a);if(m!=64)j+=String.fromCharCode(c);if(n!=64)j+=String.fromCharCode(b)}return j=h._utf8_decode(j)},_utf8_encode:function(f){f=f.replace(/\r\n/g,"\n");for(var j="",
a=0;a<f.length;a++){var c=f.charCodeAt(a);if(c<128)j+=String.fromCharCode(c);else{if(c>127&&c<2048)j+=String.fromCharCode(c>>6|192);else{j+=String.fromCharCode(c>>12|224);j+=String.fromCharCode(c>>6&63|128)}j+=String.fromCharCode(c&63|128)}}return j},_utf8_decode:function(f){for(var j="",a=0,c=c1=c2=0;a<f.length;){c=f.charCodeAt(a);if(c<128){j+=String.fromCharCode(c);a++}else if(c>191&&c<224){c2=f.charCodeAt(a+1);j+=String.fromCharCode((c&31)<<6|c2&63);a+=2}else{c2=f.charCodeAt(a+1);c3=f.charCodeAt(a+
2);j+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);a+=3}}return j}};o.base64=h});s.module("./casti_ctrl_t",function(o,h){h("sys");var f=h("../lib/neoip_rpc_node"),j=h("../vendor/node-helpers/equiv").equiv,a=function(c){var b=c.call_url||console.assert(false),m=c.casti_opts||console.assert(false),n=c.event_cb||function(){},k=c.req_timer_delay||500,d=c.verbose||0,i=null,e=null,g=function(){e!==null&&clearTimeout(e);e=null},l=function(){d>1&&console.log("req_timer expired. next in "+k+"-msec");q()},
p=null,q=function(){d>1&&console.log("rpc: rpc_call_request enter");console.assert(p===null);p=f.rpc_call.create({call_url:b,method_name:"request_stream",method_args:[m.mdata_srv_uri,m.cast_name,m.cast_privtext,m.scasti_uri,m.scasti_mod,m.http_peersrc_uri,m.web2srv_str],success_cb:function(v){t();g();var y=void 0;if(y==undefined)y=k;console.assert(e===null);e=setTimeout(l,y);if(v.length>0){i=v;r("ispublished",{cast_privhash:v})}else{i=null;r("nopublished",null)}},failure_cb:function(v){i=null;d&&
console.log("failure: "+h("sys").inspect(v));t();r("rpc_error",null)}})},u=function(){d>1&&console.log("rpc: rpc_call_release enter");console.assert(p===null);i=null;p=f.rpc_call.create({call_url:b,method_name:"release_stream",method_args:[m.mdata_srv_uri,m.cast_name,m.cast_privtext],success_cb:function(){t();r("released",null)},failure_cb:function(v){d&&console.log("failure: "+h("sys").inspect(v));t();r("rpc_error",null)}})},t=function(){p!==null&&p.destroy();p=null},x=null,w=null,r=function(v,y){if(!(v==
x&&j(y,w))){w=y;x=v;n(v,y)}};q();return{release:function(){t();g();u()},published:function(){return i!==null},cast_privhash:function(){return i},destroy:function(){t();g()}}};a.create=function(c){return new a(c)};o.create=a.create});s.module("./casto_testclient_t",function(o,h){var f=h("http"),j=function(a){console.assert(a.stream_url);var c=a.stream_url,b=a.event_cb||function(){},m=a.notify_unit||1024,n=a.verbose||0,k=a.idle_timer_delay||2E4,d=a.max_recved_len||null,i=null,e=function(){n>1&&console.log("launch idle_timer timeout in "+
k+"-msec");i=setTimeout(l,k)},g=function(){i!==null&&clearTimeout(i);i=null},l=function(){n&&console.log("idle timer expired. next in "+k+"-msec");b("error","idle timeout after "+k+"-msec")},p=null;(function(){var q=0,u=0,t=h("url").parse(c),x=f.createClient(t.port||80,t.hostname);x.on("error",function(w){b("error",w.message)});x.on("timeout",function(w){b("error",w.message)});p=x.request("GET",t.pathname,{host:t.host});p.on("response",function(w){n&&console.log("Connected to "+c);e();if(w.statusCode!=
200)b("error","statusCode="+w.statusCode);else{b("cnx_begin",null);w.on("data",function(r){n&&console.log("idle_time_refresh");g();e();q+=r.length;r=Math.floor(u/m);r=Math.floor(q/m)-r;r>0&&b("recved_size",r);u=q;d&&q>=d&&b("recved_len_maxed",null)});w.on("end",function(){n&&console.log("Connection ended");b("cnx_closed",null)})}});p.end()})();return{destroy:function(){g();p.connection.destroy()}}};j.create=function(a){return new j(a)};o.create=j.create});s.module("./collection",function(o){o.collection=
function(){var h={},f=function(c,b){for(var m=c.split("/"),n=h,k=m[0],d=0;d<m.length-1;d++){typeof n[k]=="undefined"&&b(n,k);n=n[k];k=m[d+1]}return{submap:n,subkey:k}},j=function(c){console.assert(a(c));var b=f(c,function(m,n){throw Error("subkey "+n+" (from key "+c+") doesnt exist");});return b.submap[b.subkey]},a=function(c){var b=null;try{b=f(c,function(n,k){throw Error("subkey "+k+" (from key "+c+") doesnt exist");})}catch(m){return false}if(typeof b.submap[b.subkey]=="undefined")return false;
return true};return{set:function(c,b){var m=f(c,function(n,k){n[k]={}});m.submap[m.subkey]=b},get:j,get_dfl:function(c,b){return a(c)?j(c):b},del:function(c){console.assert(a(c));var b=f(c,function(m,n){throw Error("subkey "+n+" (from key "+c+") doesnt exist");});delete b.submap[b.subkey]},has:a}}});s.module("./neoip_app_detect",function(o,h){var f=typeof process=="object"?h("./neoip_rpc_node").rpc_call:h("./neoip_rpc_web").rpc_call,j={oload:{port_beg:4550,port_end:4553},casto:{port_beg:4560,port_end:4563},
casti:{port_beg:4570,port_end:4573}},a={},c=function(e){return e in a},b=function(){a={}},m=function(e){var g=e.app_suffix||console.assert(e.app_suffix),l=e.success_cb||function(){},p=e.failure_cb||function(){},q=e.nocache||false,u=e.verbose||0,t=e.hostname||"127.0.0.1";console.assert(g=="oload"||g=="casti"||g=="casto");if(g in a&&!q){var x=a[g];x.version===false?setTimeout(function(){p(true)},0):setTimeout(function(){l(x.root_url,x.version)},0)}else{var w=j[g].port_end,r=j[g].port_beg,v=function(A){u&&
console.log("found "+g+" version "+A+" at port "+r);var C="http://"+t+":"+r;a[g]={root_url:C,version:A};l(C,A)},y=function(){u&&console.log(g+" not found port_cur="+r);if(r==w){a[g]={version:false};p("not found")}else{r++;D()}},D=function(){f.create({call_url:"http://"+t+":"+r+"/neoip_"+g+"_appdetect_jsrest.js",method_name:"probe_apps",method_args:[],success_cb:v,failure_cb:y})};D()}},n=function(e,g){var l=e.match(/(\d+).(\d+).(\d+)/),p=g.match(/(\d+).(\d+).(\d+)/),q=parseInt(l[1],10),u=parseInt(p[1],
10);if(q>u)return+1;if(q<u)return-1;q=parseInt(l[2],10);u=parseInt(p[2],10);if(q>u)return+1;if(q<u)return-1;l=parseInt(l[3],10);p=parseInt(p[3],10);if(l>p)return+1;if(l<p)return-1;return 0},k={oload:"0.0.1",casto:"0.0.1",casti:"0.0.2"},d=function(){for(var e in k)if(!(e in a))return null;for(e in k)if(a[e].version===false)return"toinstall";for(e in k)if(n(a[e].version,k[e])<0)return"toupgrade";return"installed"},i=function(e){var g=e.completed_cb||function(){},l=e.hostname||"127.0.0.1";e=e.nocache||
false;var p=3,q=function(){p-=1;if(!(p>0)){var t=d();g(t)}};for(var u in k)m({app_suffix:u,hostname:l,nocache:e,success_cb:q,failure_cb:q})};o.discover_app=m;o.discover_webpeer=i;o.cache_contain=c;o.cache_get=function(e){return a[e]};o.cache_clear=b;o.avail=function(e){if(!c(e))return false;if(a[e].version==false)return false;return true};o.probe=m;o.webpeer_probe=i;o.webpeer_avail=function(){return d()=="installed"};o.webpeer_status=d;o.clear=b});s.module("./neoip_jsonp_call",function(o){var h=0;
o.jsonp_call=function(f){var j=f.url||console.assert(f.url),a=f.success_cb||function(){},c=f.failure_cb||function(){},b="jsonp_call_cb_"+h++;console.assert(/callback=\?(&|$)/.test(j));j=j.replace("callback=?","callback="+b);var m=document.getElementsByTagName("head")[0],n=document.createElement("script"),k=function(){m.removeChild(n);window[b]=undefined;try{delete window[b]}catch(d){}};window[b]=function(d){k();a(d)};n.src=j;n.onerror=function(){k();c("Network error")};m.appendChild(n);return{destroy:k}}});
s.module("./neoip_rpc_node",function(o,h){var f=h("http"),j=function(a){var c=a.call_url||console.assert(a.call_url),b=a.method_name||console.assert(a.method_name),m=a.method_args||[],n=a.success_cb||function(){},k=a.failure_cb||function(){},d=a.verbose||0,i=null;(function(){for(var e=h("url").parse(c),g=e.pathname+"?method_name="+b,l=0;l<m.length;l++)g+="&arg"+l+"="+escape(m[l]);l=f.createClient(e.port||80,e.hostname);l.on("error",function(p){k({code:-1,string:p.message})});l.on("timeout",function(p){k({code:-1,
string:p.message})});i=l.request("GET",g,{host:e.host});i.on("response",function(p){d&&console.log("STATUS: "+p.statusCode);d&&console.log("HEADERS: "+JSON.stringify(p.headers));if(p.statusCode!=200)return k(Error("http statuscode="+p.statuscode));p.setEncoding("utf8");p.on("data",function(q){d&&console.log("BODY: "+q);q=JSON.parse(q);if(q.fault){d>1&&console.dir(q);k(q.fault)}else n(q.returned_val)})});i.end()})();return{destroy:function(){i.connection.destroy()}}};j.create=function(a){return new j(a)};
o.rpc_call=j});s.module("./neoip_rpc_web",function(o,h){var f=h("neoip_jsonp_call").jsonp_call,j=function(a){var c=a.call_url||console.assert(a.call_url),b=a.method_name||console.assert(a.method_name),m=a.method_args||[],n=a.success_cb||function(){},k=a.failure_cb||function(){},d=a.verbose||0,i=null;(function(){console.assert(i==null);for(var e=c+"?callback=?&method_name="+b,g=0;g<m.length;g++)e+="&arg"+g+"="+escape(m[g]);d>1&&console.log("url="+e);i=new f({url:e,success_cb:function(l){d>1&&console.dir(l);
l.fault?k(l.fault):n(l.returned_val)},failure_cb:function(l){d&&console.log("failed due to "+l);k(l)}})})();return{destroy:function(){i&&i.destroy();i=null}}};j.create=function(a){return new j(a)};o.rpc_call=j});s.module("./url_builder_casto",function(o){o.create=function(h){var f=h.base_url||console.assert(false),j=h.cast_privhash||console.assert(false),a=h.cast_name||console.assert(false);h=h.mdata_srv_uri||null;f=f+"/"+j+"/"+a;if(h)f+="?mdata_srv_uri="+escape(h);return f}});s.module("./url_builder_oload_t",
function(o,h){var f=h("./collection").collection,j=h("./base64").base64,a=function(c){var b=new f,m=function(d){for(var i=0;;i++){var e="outter_var/dupuri/"+i;if(!b.has(e)){b.set(e,d);break}}},n=function(){try{if(!b.has("outter_uri"))throw Error("No outter_uri");if(!b.has("inner_uri"))throw Error("No inner_uri");}catch(d){console.log("url_builder_oload_t not sane due to "+d);return false}return true},k=function(d){var i=j.decode_safe,e=d.substr(0,d.indexOf("/http:/"));for(d=d.substr(d.indexOf("/http:/")+
1);;){var g=e.substr(e.lastIndexOf("/")+1);if(g.substr(0,1)=="*"){var l=g.match(/\*(.+)\*(.+)$/);g=l[1];l=l[2];g!="dupuri"?b.set("outter_var/"+g,l):m(i(l))}else if(g=="raw"||g=="flv")b.set("outter_var/mod",g);else break;e=e.substr(0,e.lastIndexOf("/"))}b.set("outter_uri",e);i=[];if(d.lastIndexOf("?")!=-1){var p=d.substr(d.lastIndexOf("?")+1).split("&");for(e=0;e<p.length;e++){l=p[e].split("=");g=l[0];l=l[1];if(g.indexOf("neoip_metavar_")!=0)i.push(p[e]);else{g=g.substr(14);b.set("minner_var/"+g,l)}}d=
d.substr(0,d.lastIndexOf("?"))}if(b.has("outter_var/subfile_level")){l=b.get("outter_var/subfile_level");g=null;for(e=0;e<l;e++)g=g?d.lastIndexOf("/",g-1):d.lastIndexOf("/");e=d.substr(g);b.set("outter_var/subfile_path",e);b.del("outter_var/subfile_level");d=d.substr(0,g)}d=d;if(i.length>0)d+="?"+i.join("&");b.set("inner_uri",d)};c!==undefined&&k(c);return{outter_uri:function(d){b.set("outter_uri",d)},inner_uri:function(d){b.set("inner_uri",d)},outter_var:function(d,i){return b.set("outter_var/"+
d,i)},minner_var:function(d,i){return b.set("minner_var/"+d,i)},dupuri:m,set:function(d,i){b.set(d,i);return this},get:b.get,get_dfl:b.get_dfl,del:b.del,has:b.has,is_sane:n,to_string:function(){var d=j.encode_safe,i="";console.assert(n());i+=b.get("outter_uri")+"/";if(b.has("outter_var/mod"))i+=b.get("outter_var/mod")+"/";for(var e in b.get_dfl("outter_var",{}))if(e!="dupuri")if(e!="subfile_path")if(e!="mod"){i+="*"+e+"*";var g=b.get("outter_var/"+e);if(e=="http_peersrc_uri")g=url_encode_safe(g);
i+=g;i+="/"}if(b.has("outter_var/subfile_path")){g=b.get("outter_var/subfile_path");g=g.split("/").length-1;i+="*subfile_level*"+g+"/"}for(var l in b.get_dfl("outter_var/dupuri",{})){i+="*dupuri*";i+=d(b.get("outter_var/dupuri/"+l));i+="/"}d=b.get("inner_uri");b.has("outter_var/subfile_path");g=b.get_dfl("outter_var/subfile_path",null);l=d.indexOf("?");i+=l!=-1?d.substr(0,l):d;if(g)i+=g;if(l!=-1)i+=d.substr(l,d.length);for(e in b.get_dfl("minner_var",{})){i+=i.indexOf("?")==-1?"?":"&";i+="neoip_metavar_"+
e+"="+escape(b.get("minner_var/"+e))}return i},from_string:k}};a.create=function(c){return new a(c)};o.url_builder_oload_t=a;o.create=a.create});s.module("./webpeer",function(o,h){var f=h("./neoip_app_detect"),j=h("./url_builder_oload_t"),a={};a.ready=function(c){f.webpeer_probe({completed_cb:function(b){if(b=="toinstall")c();else if(b=="toupgrade")c();else b=="installed"?c():console.assert()}})};a.present=function(){return f.webpeer_status()=="installed"};a.url=function(c){if(!a.present())return c;
return j.create(c).set("outter_uri",f.cache_get("oload").root_url).to_string()};a.monitor=function(c){if(typeof c=="undefined")c={};if(typeof c=="function")c={completed_cb:c};var b=c.completed_cb||function(){},m=c.delay||1E3,n=null,k=function(){f.webpeer_probe({completed_cb:function(d){if(d!=n){n=d;b(d)}setTimeout(k,m)},nocache:true})};setTimeout(k,0)};a.badge=function(c){a.ready(function(){var b=document.getElementById(c);b.src="http://webpeer.it/images/badge/"+(a.present()?"accept.png":"exclamation.png");
b.title=a.present()?"You are a web peer. Congrats!":"You are not yet a web peer. Click to be one."})};o.present=a.present;o.url=a.url;o.ready=a.ready;o.badge=a.badge});E.webpeer=s("./webpeer")})(window);
